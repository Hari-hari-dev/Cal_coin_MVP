<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Daily FaceScan Airdrop Demo</title>
  <!-- 1) Solana Web3.js -->
  <script src="https://unpkg.com/@solana/web3.js@1.84.1/lib/index.iife.js"></script>

  <!-- 2) Anchor IIFE Build (0.26.0) -->
  <script src="https://unpkg.com/@project-serum/anchor@0.26.0/dist/browser/index.iife.min.js"></script>

  <script>
    // Quick check if Anchor loaded:
    console.log("Anchor loaded?", typeof anchor !== "undefined");
  </script>

  <style>
    body {
      font-family: Arial, sans-serif; text-align: center; margin-top: 50px;
    }
    button {
      font-size: 16px; padding: 10px 20px; margin: 5px; cursor: pointer;
    }
    #status {
      margin-top: 20px; font-size: 18px; white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>Daily FaceScan Airdrop Demo</h1>

  <!-- Buttons for Connect, Initialize, Claim, Debug -->
  <button id="connectBtn">Connect Phantom</button>
  <button id="initBtn">Initialize</button>
  <button id="claimBtn">Claim</button>
  <button id="debugBtn">Debug</button>

  <div id="status">Not connected</div>

  <script>
    /*********************************************************
     * 1) Program + IDL Info
     *********************************************************/
    // We'll use devnet or localnet; update to your liking
    const NETWORK_URL = "https://api.devnet.solana.com"; 
    const PROGRAM_ID = new solanaWeb3.PublicKey("6FhraHnUCBLHUXyKypmZPv67VbbWb1GtPzmyrGLsZ7EV");

    // Paste your daily_facescan IDL below (shortened for brevity).
    const IDL = {
      "version": "0.1.0",
      "name": "daily_facescan",
      // ... (rest of the instructions, accounts, and errors)
      "instructions": [
        {
          "name": "initialize",
          "accounts": [
            {"name": "airdrop","isMut": true,"isSigner": true},
            {"name": "mint","isMut": true,"isSigner": true},
            {"name": "mintAuthority","isMut": false,"isSigner": false},
            {"name": "authority","isMut": true,"isSigner": true},
            {"name": "systemProgram","isMut": false,"isSigner": false},
            {"name": "tokenProgram","isMut": false,"isSigner": false},
            {"name": "rent","isMut": false,"isSigner": false}
          ],
          "args": []
        },
        {
          "name": "claim",
          "accounts": [
            {"name": "airdrop","isMut": false,"isSigner": false},
            {"name": "payer","isMut": true,"isSigner": true},
            {"name": "mintAuthority","isMut": false,"isSigner": false},
            {"name": "ticket","isMut": true,"isSigner": false},
            {"name": "mint","isMut": true,"isSigner": false},
            {"name": "recipientTokenAccount","isMut": true,"isSigner": false},
            {"name": "gatewayToken","isMut": false,"isSigner": false},
            {"name": "recipient","isMut": true,"isSigner": false},
            {"name": "systemProgram","isMut": false,"isSigner": false},
            {"name": "tokenProgram","isMut": false,"isSigner": false},
            {"name": "associatedTokenProgram","isMut": false,"isSigner": false},
            {"name": "rent","isMut": false,"isSigner": false}
          ],
          "args": []
        }
        // ... plus addOwner, deleteOwner, etc. if you want extra instructions
      ],
      "accounts": [
        {
          "name": "Airdrop",
          "type": {
            "kind": "struct",
            "fields": [
              {"name": "gatekeeperNetwork","type": "publicKey"},
              {"name": "mint","type": "publicKey"},
              {"name": "dailyAmount","type": "u64"},
              {"name": "lastClaimTimestamp","type": "i64"},
              {
                "name": "owners",
                "type": {"array": ["publicKey",6]}
              },
              {"name": "ownersCount","type": "u8"}
            ]
          }
        },
        {
          "name": "Ticket",
          "type": {"kind": "struct","fields": []}
        }
      ],
      "errors": [
        {"code":6000,"name":"InvalidPass","msg":"Invalid gateway token or gating check not satisfied"},
        {"code":6001,"name":"Unauthorized","msg":"You are not an authorized owner"}
        // ...
      ]
    };

    /*********************************************************
     * 2) Global Variables
     *********************************************************/
    let program;   // Anchor Program
    let provider;  // Anchor Provider
    let airdropKP; // Keypair for "airdrop" account
    let mintKP;    // Keypair for the SPL mint
    let mintAuthPda; // PDA for the mint authority

    /*********************************************************
     * 3) Connect Phantom
     *********************************************************/
    async function connectPhantom() {
      if (!window.solana) {
        alert("Phantom wallet not found. Please install it first!");
        return;
      }
      try {
        await window.solana.connect();
        const pubkey = window.solana.publicKey.toBase58();
        document.getElementById('status').textContent =
          "Connected to Phantom: " + pubkey;
        console.log("Phantom connected:", pubkey);
      } catch (err) {
        console.error("Phantom connect error:", err);
        alert("Phantom connect error: " + err.message);
      }
    }

    /*********************************************************
     * 4) Setup Anchor
     *********************************************************/
    function setupAnchor() {
      if (typeof anchor === "undefined") {
        alert("Anchor not loaded. Check your script references.");
        return;
      }
      // Create a connection to the cluster
      const connection = new solanaWeb3.Connection(NETWORK_URL, "processed");

      // Construct a wallet interface from Phantom
      const wallet = {
        publicKey: window.solana.publicKey,
        signTransaction: (tx) => window.solana.signTransaction(tx),
        signAllTransactions: (txs) => window.solana.signAllTransactions(txs)
      };

      // Create an AnchorProvider
      provider = new anchor.AnchorProvider(connection, wallet, {
        preflightCommitment: "processed"
      });

      // Create the program (combines IDL, programID, & provider)
      program = new anchor.Program(IDL, PROGRAM_ID, provider);
    }

    /*********************************************************
     * 5) Initialize
     *********************************************************/
    async function onInitialize() {
      // Must have Phantom connected
      if (!window.solana || !window.solana.publicKey) {
        alert("Connect Phantom first!");
        return;
      }
      if (!program) {
        setupAnchor();
      }
      // Generate two new Keypairs for the airdrop & mint accounts
      airdropKP = anchor.web3.Keypair.generate();
      mintKP = anchor.web3.Keypair.generate();

      try {
        // Derive the mintAuthority via seeds
        const [pda] = await anchor.web3.PublicKey.findProgramAddress(
          [airdropKP.publicKey.toBuffer(), Buffer.from("mint_authority")],
          PROGRAM_ID
        );
        mintAuthPda = pda;

        // Call daily_facescan::initialize
        await program.methods.initialize()
          .accounts({
            airdrop: airdropKP.publicKey,
            mint: mintKP.publicKey,
            mintAuthority: mintAuthPda,
            authority: provider.wallet.publicKey, // the user
            systemProgram: solanaWeb3.SystemProgram.programId,
            tokenProgram: anchor.utils.token.TOKEN_PROGRAM_ID,
            rent: solanaWeb3.SYSVAR_RENT_PUBKEY
          })
          .signers([airdropKP, mintKP])
          .rpc();

        document.getElementById("status").textContent =
          "Initialize successful!\n" +
          "AirdropPubkey: " + airdropKP.publicKey.toBase58() + "\n" +
          "MintPubkey: " + mintKP.publicKey.toBase58();
      } catch (err) {
        console.error("Initialize failed:", err);
        alert("Initialize error: " + err.message);
      }
    }

    /*********************************************************
     * 6) Claim
     *********************************************************/
    async function onClaim() {
      if (!program) {
        setupAnchor();
      }
      if (!airdropKP) {
        alert("No airdropPubkey known. Did you run 'Initialize' first?");
        return;
      }
      try {
        // Derive the "ticket" PDA from seeds
        const [ticketPda] = await anchor.web3.PublicKey.findProgramAddress(
          [
            airdropKP.publicKey.toBuffer(),
            provider.wallet.publicKey.toBuffer(),
            Buffer.from("ticket")
          ],
          PROGRAM_ID
        );

        // Associated token account for the minted token
        const recipientAta = await anchor.utils.token.associatedAddress({
          mint: mintKP.publicKey,
          owner: provider.wallet.publicKey
        });

        // Fake a gateway token (replace w/ real if you integrate Civic)
        const gatewayToken = anchor.web3.Keypair.generate().publicKey;

        // Call daily_facescan::claim
        await program.methods.claim()
          .accounts({
            airdrop: airdropKP.publicKey,
            payer: provider.wallet.publicKey,
            mintAuthority: mintAuthPda,
            ticket: ticketPda,
            mint: mintKP.publicKey,
            recipientTokenAccount: recipientAta,
            gatewayToken,
            recipient: provider.wallet.publicKey,
            systemProgram: solanaWeb3.SystemProgram.programId,
            tokenProgram: anchor.utils.token.TOKEN_PROGRAM_ID,
            associatedTokenProgram: anchor.utils.token.ASSOCIATED_PROGRAM_ID,
            rent: solanaWeb3.SYSVAR_RENT_PUBKEY
          })
          .rpc();

        document.getElementById("status").textContent =
          "Claim successful! Check your token account for minted tokens.";
      } catch (err) {
        console.error("Claim failed:", err);
        alert("Claim error: " + err.message);
      }
    }

    /*********************************************************
     * 7) Debug: fetch Airdrop state
     *********************************************************/
    async function onDebug() {
      if (!program) {
        setupAnchor();
      }
      if (!airdropKP) {
        alert("No airdropPubkey known. Did you run Initialize first?");
        return;
      }
      try {
        const airdropState = await program.account.airdrop.fetch(airdropKP.publicKey);
        console.log("Airdrop state:", airdropState);
        document.getElementById("status").textContent =
          "Airdrop state:\n" + JSON.stringify(airdropState, null, 2);
      } catch (err) {
        console.error("Debug error:", err);
        alert("Debug fetch failed: " + err.message);
      }
    }

    // Attach button handlers
    document.getElementById("connectBtn").onclick = connectPhantom;
    document.getElementById("initBtn").onclick = onInitialize;
    document.getElementById("claimBtn").onclick = onClaim;
    document.getElementById("debugBtn").onclick = onDebug;
  </script>
</body>
</html>
