<!DOCTYPE html>
<html>
<head>
  <title>Daily FaceScan Airdrop Demo</title>
  <!-- Include the Solana web3 library & Anchor.
       You can fetch from CDN or local files. -->
  <script src="https://unpkg.com/@solana/web3.js@1.84.1/lib/index.iife.js"></script>
  <script src="https://unpkg.com/@project-serum/anchor@0.27.0/dist/anchor.iife.js"></script>
</head>
<body>
  <h1>Daily FaceScan Airdrop Demo v4</h1>
  
  <!-- Buttons -->
  <button id="connectBtn">Connect Phantom</button>
  <button id="initBtn">Initialize</button>
  <button id="claimBtn">Claim</button>
  
  <div id="status"></div>
  <div id="info"></div>

  <script>
    /*********************************************************
     * 1) Global Variables & Setup
     *********************************************************/
    // Use devnet for demonstration
    const NETWORK_URL = "https://api.devnet.solana.com";
    
    // The Program ID from declare_id! in Rust
    const PROGRAM_ID = new solanaWeb3.PublicKey("6FhraHnUCBLHUXyKypmZPv67VbbWb1GtPzmyrGLsZ7EV");

    // If you already know your minted token address, you can show it:
    const KNOWN_MINT_PUBKEY = new solanaWeb3.PublicKey("HdTS8QFExDsDcTfgQGGeGsAMbRCtoeiW4Jxfor4BhW44");

    // Minimal IDL placeholder
    const IDL = {
      version: "0.0.1",
      name: "daily_facescan",
      instructions: [
        { name: "initialize", accounts: [], args: [] },
        { name: "claim", accounts: [], args: [] }
      ]
    };

    let program;
    let provider;

    // For demonstration placeholders
    let airdropPubkey;        
    let mintPubkey;
    let mintAuthorityPubkey;  

    /*********************************************************
     * 2) Connect to Phantom
     *********************************************************/
    async function connectPhantom() {
      // Check if Phantom is installed
      if (!window.solana) {
        alert("Phantom wallet not found. Please install it first!");
        return;
      }
      try {
        // Attempt connection
        const resp = await window.solana.connect();
        const userPublicKey = window.solana.publicKey.toBase58();
        console.log("Connected to Phantom as:", userPublicKey);

        document.getElementById('status').textContent =
          "Connected to Phantom: " + userPublicKey;

        // Display known info about the program + mint
        const infoDiv = document.getElementById("info");
        infoDiv.innerHTML = `
          <p><strong>Program ID:</strong> ${PROGRAM_ID.toBase58()}</p>
          <p><strong>Known Mint Address:</strong> ${KNOWN_MINT_PUBKEY.toBase58()}</p>
        `;
      } catch (err) {
        console.error("Phantom connect error:", err);
        alert("Failed to connect to Phantom.");
      }
    }

    /*********************************************************
     * 3) Setup Anchor (Provider, Program)
     *********************************************************/
    function setupAnchor() {
      const connection = new solanaWeb3.Connection(NETWORK_URL, "processed");

      // Use Phantom as wallet
      const wallet = {
        publicKey: window.solana.publicKey,
        signTransaction: (tx) => window.solana.signTransaction(tx),
        signAllTransactions: (txs) => window.solana.signAllTransactions(txs),
      };

      provider = new anchor.AnchorProvider(connection, wallet, {
        preflightCommitment: "processed",
      });

      // Create the Program instance
      program = new anchor.Program(IDL, PROGRAM_ID, provider);
    }

    /*********************************************************
     * 4) Initialize
     *********************************************************/
    async function onInitialize() {
      if (!window.solana || !window.solana.publicKey) {
        alert("Connect Phantom first!");
        return;
      }
      if (!program) {
        setupAnchor();
      }

      // Generate placeholders for demonstration
      airdropPubkey = anchor.web3.Keypair.generate();
      mintPubkey = anchor.web3.Keypair.generate();

      // Derive mintAuthority from seeds
      const [mintAuthPda] = await anchor.web3.PublicKey.findProgramAddress(
        [airdropPubkey.publicKey.toBuffer(), Buffer.from("mint_authority")],
        PROGRAM_ID
      );
      mintAuthorityPubkey = mintAuthPda;

      try {
        await program.methods.initialize()
          .accounts({
            airdrop: airdropPubkey.publicKey,
            mint: mintPubkey.publicKey,
            mintAuthority: mintAuthorityPubkey,
            authority: provider.wallet.publicKey,
            systemProgram: anchor.web3.SystemProgram.programId,
            tokenProgram: anchor.utils.token.TOKEN_PROGRAM_ID,
            rent: anchor.web3.SYSVAR_RENT_PUBKEY,
          })
          .signers([airdropPubkey, mintPubkey])  // "init" accounts
          .rpc();

        document.getElementById('status').textContent = "Initialize successful!";
        console.log("Initialized with new mintPubkey:", mintPubkey.publicKey.toBase58());
      } catch (err) {
        console.error("Initialize failed:", err);
        alert("Initialize failed: " + err.message);
      }
    }

    /*********************************************************
     * 5) Claim
     *********************************************************/
    async function onClaim() {
      if (!program) {
        alert("Program not set up yet. Try Initialize first!");
        return;
      }
      try {
        // Derive seeds for ticket
        const [ticketPda] = await anchor.web3.PublicKey.findProgramAddress(
          [
            airdropPubkey.publicKey.toBuffer(),
            provider.wallet.publicKey.toBuffer(),
            Buffer.from("ticket")
          ],
          PROGRAM_ID
        );

        // Derive ATA
        const recipientTokenAccount = await anchor.utils.token.associatedAddress({
          mint: mintPubkey.publicKey,
          owner: provider.wallet.publicKey,
        });

        // "Fake" gateway token for now
        const gatewayToken = anchor.web3.Keypair.generate().publicKey;

        await program.methods.claim()
          .accounts({
            airdrop: airdropPubkey.publicKey,
            payer: provider.wallet.publicKey,
            mintAuthority: mintAuthorityPubkey,
            ticket: ticketPda,
            mint: mintPubkey.publicKey,
            recipientTokenAccount,
            gatewayToken,
            recipient: provider.wallet.publicKey,
            systemProgram: anchor.web3.SystemProgram.programId,
            tokenProgram: anchor.utils.token.TOKEN_PROGRAM_ID,
            associatedTokenProgram: anchor.utils.token.ASSOCIATED_PROGRAM_ID,
            rent: anchor.web3.SYSVAR_RENT_PUBKEY,
          })
          .rpc();

        document.getElementById('status').textContent = "Claim successful!";
      } catch (err) {
        console.error("Claim failed:", err);
        alert("Claim failed: " + err.message);
      }
    }

    // ------------------------------------------------------
    // DOM Event Listeners
    // ------------------------------------------------------
    document.getElementById("connectBtn").onclick = connectPhantom;
    document.getElementById("initBtn").onclick = onInitialize;
    document.getElementById("claimBtn").onclick = onClaim;
  </script>
</body>
</html>
