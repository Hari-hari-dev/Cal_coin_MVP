<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Anchor 0.29 + Buffer Polyfill in Browser</title>

  <!-- 1) Solana Web3 for Phantom usage -->
  <script src="https://unpkg.com/@solana/web3.js@1.84.1/lib/index.iife.js"></script>

  <!-- 2) Buffer polyfill: pinned version + known dist build -->
  <!-- e.g. buffer@5.6.0 or 5.7.1 or 6.x, but must be a build that attaches to window.buffer -->
  <script src="https://unpkg.com/buffer@5.7.1/dist/index.js"></script>
  <script>
    // Some builds put the exported package under 'window.buffer'
    // so we do:
    if (!window.buffer || !window.buffer.Buffer) {
      console.error("Buffer polyfill not found under window.buffer.Buffer");
    } else {
      window.Buffer = window.buffer.Buffer;
      console.log("Buffer polyfill assigned to window.Buffer");
    }
  </script>

  <!-- 3) Anchor 0.29.0 IIFE build -->
  <script src="https://unpkg.com/@project-serum/anchor@0.29.0/dist/anchor.iife.js"></script>
</head>
<body>
  <h1>Anchor 0.29 + Phantom Test</h1>

  <button id="connectBtn">Connect Phantom</button>
  <button id="testBtn">Test Anchor</button>

  <pre id="status"></pre>

  <script>
    let userPublicKey;

    // Connect Phantom
    async function connectPhantom() {
      if (!window.solana) {
        alert("Phantom not found");
        return;
      }
      try {
        await window.solana.connect();
        userPublicKey = window.solana.publicKey;
        document.getElementById("status").textContent =
          "Phantom connected: " + userPublicKey.toBase58();
      } catch (err) {
        console.error("Connect error:", err);
      }
    }

    // Test if Anchor is loaded
    async function testAnchor() {
      try {
        if (typeof anchor === "undefined") {
          throw new Error("anchor is still undefined");
        }

        // Suppose we build a minimal provider:
        const connection = new solanaWeb3.Connection(
          "https://api.devnet.solana.com",
          "confirmed"
        );
        const wallet = {
          publicKey: userPublicKey,
          signTransaction: (tx) => window.solana.signTransaction(tx),
          signAllTransactions: (txs) => window.solana.signAllTransactions(txs),
        };

        const provider = new anchor.AnchorProvider(connection, wallet, {
          preflightCommitment: "confirmed"
        });
        // If this works, then anchor is indeed functional
        document.getElementById("status").textContent =
          "Anchor loaded. Provider created successfully!";
        console.log("Provider:", provider);
      } catch (err) {
        document.getElementById("status").textContent =
          "Test anchor error: " + err.message;
        console.error(err);
      }
    }

    // wire up
    document.getElementById("connectBtn").onclick = connectPhantom;
    document.getElementById("testBtn").onclick = testAnchor;
  </script>
</body>
</html>
