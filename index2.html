<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Anchor 0.29 + Buffer Polyfill</title>
</head>
<body>
  <h1>Anchor 0.29 + Buffer Polyfill</h1>

  <!-- Buttons -->
  <button id="connectBtn">Connect Phantom</button>
  <button id="testBtn">Test Anchor</button>

  <pre id="status"></pre>

  <!-- Import Scripts -->
  <script type="module">
    /********************************************************
     * Import Buffer Polyfill and Anchor
     ********************************************************/
    import { Buffer } from "https://unpkg.com/buffer@6.0.3/index.js?module";
    import * as anchor from "https://unpkg.com/@coral-xyz/anchor@0.29.0/dist/browser/index.js";

    // Attach Buffer to window
    window.Buffer = Buffer;

    // Verify Anchor Import
    if (typeof anchor === "undefined") {
      console.error("Anchor is undefined. Ensure the script URL is correct.");
    } else {
      console.log("Anchor imported successfully:", anchor);
    }

    /********************************************************
     * Global Variables
     ********************************************************/
    let userPublicKey;

    /********************************************************
     * Connect to Phantom Wallet
     ********************************************************/
    async function connectPhantom() {
      if (!window.solana || !window.solana.isPhantom) {
        alert("Phantom wallet not found. Please install/enable it!");
        return;
      }
      try {
        // Connect to Phantom
        const resp = await window.solana.connect();
        userPublicKey = resp.publicKey;

        // Update status
        document.getElementById("status").textContent =
          "Phantom connected: " + userPublicKey.toBase58();
        console.log("Phantom connected:", userPublicKey.toBase58());
      } catch (err) {
        console.error("Phantom connection error:", err);
        document.getElementById("status").textContent =
          "Connection failed: " + err.message;
      }
    }

    /********************************************************
     * Test Anchor Integration
     ********************************************************/
    async function testAnchor() {
      if (!userPublicKey) {
        alert("Please connect Phantom first!");
        return;
      }
      try {
        // Create a Solana connection
        const connection = new anchor.web3.Connection("https://api.devnet.solana.com", "confirmed");

        // Create an Anchor Provider
        const provider = new anchor.AnchorProvider(connection, window.solana, {
          preflightCommitment: "confirmed",
        });

        // Confirm provider setup
        document.getElementById("status").textContent =
          "Anchor loaded! Provider setup complete.\nPublicKey: " + userPublicKey.toBase58();
        console.log("Anchor Provider initialized:", provider);
      } catch (err) {
        console.error("Anchor setup error:", err);
        document.getElementById("status").textContent =
          "Anchor setup failed: " + err.message;
      }
    }

    /********************************************************
     * Attach Event Listeners
     ********************************************************/
    document.getElementById("connectBtn").onclick = connectPhantom;
    document.getElementById("testBtn").onclick = testAnchor;
  </script>
</body>
</html>
