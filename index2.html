<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Anchor 0.29 + Buffer Polyfill (Browser)</title>
  <!-- 1) Solana web3 for Phantom usage -->
  <script src="https://unpkg.com/@solana/web3.js@1.84.1/lib/index.iife.js"></script>

  <!-- 2) Buffer polyfill: use a pre-bundled file to avoid 'require' in the browser -->
  <!-- For instance, buffer@6.0.3/dist/buffer.min.js -->
  <script src="https://unpkg.com/buffer@6.0.3/dist/buffer.min.js"></script>
  <script>
    // Expose 'Buffer' globally so Anchor can use it in the browser
    window.Buffer = window.buffer.Buffer;
  </script>

  <!-- 3) Anchor 0.29.0 IIFE build -->
  <script src="https://unpkg.com/@project-serum/anchor@0.29.0/dist/anchor.iife.js"></script>
</head>
<body>
  <h1>Anchor 0.29 + Phantom in Browser</h1>

  <!-- Phantom Connect + Test Buttons -->
  <button id="connectBtn">Connect Phantom</button>
  <button id="testBtn">Test Anchor Setup</button>

  <pre id="status"></pre>

  <script>
    /**********************************************************
     * 1) Connect to Phantom
     **********************************************************/
    let userPublicKey;

    async function connectPhantom() {
      if (!window.solana) {
        alert("Phantom not found. Please install it!");
        return;
      }
      try {
        await window.solana.connect();
        userPublicKey = window.solana.publicKey;
        console.log("Phantom connected as:", userPublicKey.toBase58());
        document.getElementById("status").textContent =
          "Phantom connected: " + userPublicKey.toBase58();
      } catch (err) {
        console.error("Phantom connect error:", err);
        document.getElementById("status").textContent =
          "Connect error: " + err.message;
      }
    }

    /**********************************************************
     * 2) Test: Use Anchor in the Browser
     **********************************************************/
    async function onTestAnchor() {
      try {
        // Check that 'anchor' is defined
        console.log("anchor version:", anchor);

        // Example: create a connection + provider
        const connection = new solanaWeb3.Connection(
          "https://api.devnet.solana.com",
          "confirmed"
        );
        const wallet = {
          publicKey: userPublicKey,
          signTransaction: (tx) => window.solana.signTransaction(tx),
          signAllTransactions: (txs) => window.solana.signAllTransactions(txs),
        };
        const provider = new anchor.AnchorProvider(connection, wallet, {
          preflightCommitment: "confirmed",
        });

        // Just log success
        document.getElementById("status").textContent =
          "Anchor loaded. Provider created. All good!";
      } catch (err) {
        console.error("Test Anchor error:", err);
        document.getElementById("status").textContent =
          "Test error: " + err.message;
      }
    }

    // Wire up the buttons
    document.getElementById("connectBtn").onclick = connectPhantom;
    document.getElementById("testBtn").onclick = onTestAnchor;
  </script>
</body>
</html>
