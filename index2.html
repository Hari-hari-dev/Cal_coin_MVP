<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily FaceScan Airdrop Demo (Fixed)</title>
  <!-- Include Solana Web3.js library -->
  <script src="https://unpkg.com/@solana/web3.js@1.84.1/lib/index.iife.js"></script>
  <!-- Include Anchor.js library -->
  <script src="https://unpkg.com/@project-serum/anchor@0.26.0/dist/anchor.iife.min.js"></script>
  <script>
    console.log('Anchor loaded:', window.anchor ? 'Yes' : 'No');
  </script>
</head>
<body>
  <h1>Daily FaceScan Airdrop Demo (Fixed)</h1>
  <button id="connectBtn">Connect Phantom</button>
  <button id="initBtn">Initialize</button>
  <button id="claimBtn">Claim</button>
  <button id="debugBtn">Debug</button>
  <div id="status">Not connected</div>

  <script>
    const NETWORK_URL = "https://api.devnet.solana.com";
    const PROGRAM_ID = new solanaWeb3.PublicKey("6FhraHnUCBLHUXyKypmZPv67VbbWb1GtPzmyrGLsZ7EV");
    const IDL = {
      /* Your IDL content here */
    };

    let program, provider, airdropPubkey, mintPubkey, mintAuthorityPubkey;

    async function connectPhantom() {
      if (!window.solana) {
        alert("Phantom wallet not found!");
        return;
      }
      try {
        await window.solana.connect();
        const userPublicKey = window.solana.publicKey.toBase58();
        document.getElementById('status').textContent = `Connected to Phantom: ${userPublicKey}`;
      } catch (err) {
        console.error(err);
        alert("Failed to connect Phantom.");
      }
    }

    function setupAnchor() {
      if (!window.anchor) {
        alert("Anchor not loaded. Check script inclusion.");
        return;
      }
      const connection = new solanaWeb3.Connection(NETWORK_URL, "processed");
      const wallet = {
        publicKey: window.solana.publicKey,
        signTransaction: (tx) => window.solana.signTransaction(tx),
        signAllTransactions: (txs) => window.solana.signAllTransactions(txs),
      };
      provider = new anchor.AnchorProvider(connection, wallet, {
        preflightCommitment: "processed",
      });
      program = new anchor.Program(IDL, PROGRAM_ID, provider);
    }

    async function onInitialize() {
      if (!program) setupAnchor();
      try {
        airdropPubkey = anchor.web3.Keypair.generate();
        mintPubkey = anchor.web3.Keypair.generate();
        const [mintAuthPda] = await anchor.web3.PublicKey.findProgramAddress(
          [airdropPubkey.publicKey.toBuffer(), Buffer.from("mint_authority")],
          PROGRAM_ID
        );
        mintAuthorityPubkey = mintAuthPda;
        await program.methods.initialize()
          .accounts({
            airdrop: airdropPubkey.publicKey,
            mint: mintPubkey.publicKey,
            mintAuthority: mintAuthorityPubkey,
            authority: provider.wallet.publicKey,
            systemProgram: anchor.web3.SystemProgram.programId,
            tokenProgram: anchor.utils.token.TOKEN_PROGRAM_ID,
            rent: anchor.web3.SYSVAR_RENT_PUBKEY,
          })
          .signers([airdropPubkey, mintPubkey])
          .rpc();
        document.getElementById('status').textContent = "Initialize successful!";
      } catch (err) {
        console.error(err);
        alert("Initialize failed.");
      }
    }

    async function onClaim() {
      if (!program) setupAnchor();
      try {
        const [ticketPda] = await anchor.web3.PublicKey.findProgramAddress(
          [
            airdropPubkey.publicKey.toBuffer(),
            provider.wallet.publicKey.toBuffer(),
            Buffer.from("ticket"),
          ],
          PROGRAM_ID
        );
        const recipientTokenAccount = await anchor.utils.token.associatedAddress({
          mint: mintPubkey.publicKey,
          owner: provider.wallet.publicKey,
        });
        await program.methods.claim()
          .accounts({
            airdrop: airdropPubkey.publicKey,
            payer: provider.wallet.publicKey,
            mintAuthority: mintAuthorityPubkey,
            ticket: ticketPda,
            mint: mintPubkey.publicKey,
            recipientTokenAccount,
            gatewayToken: anchor.web3.Keypair.generate().publicKey,
            recipient: provider.wallet.publicKey,
            systemProgram: anchor.web3.SystemProgram.programId,
            tokenProgram: anchor.utils.token.TOKEN_PROGRAM_ID,
            associatedTokenProgram: anchor.utils.token.ASSOCIATED_PROGRAM_ID,
            rent: anchor.web3.SYSVAR_RENT_PUBKEY,
          })
          .rpc();
        document.getElementById('status').textContent = "Claim successful!";
      } catch (err) {
        console.error(err);
        alert("Claim failed.");
      }
    }

    document.getElementById("connectBtn").onclick = connectPhantom;
    document.getElementById("initBtn").onclick = onInitialize;
    document.getElementById("claimBtn").onclick = onClaim;
  </script>
</body>
</html>
